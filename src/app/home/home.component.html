<div class="high-level-container">
    <div class="input-container">
        <div
            class="card input-container-card border-secondary"
            [ngClass]="{
                'input-container-card-dark-mode': darkModeService.isDarkMode
            }"
        >
            <div
                class="card-body input-container-card-body"
                [ngClass]="{
                    'card-body-dark-mode': darkModeService.isDarkMode
                }"
            >
                <div class="editor-flex">
                    <div
                        id="editor"
                        (paste)="onTextPaste($event)"
                        (copy)="onTextCopy($event)"
                        (cut)="onTextCut($event)"
                        (keydown)="onKeyDown($event)"
                        [ngClass]="{
                            'editor-dark-mode': darkModeService.isDarkMode,
                            'editor-max-characters':
                                hasEditorOverMaxCharacters()
                        }"
                        contenteditable="true"
                        [innerHTML]="innerHTMLOfEditor"
                        spellcheck="false"
                        autocapitalize="off"
                        role="textbox"
                        aria-label="redaktori"
                        aria-multiline="true"
                        data-test="editor"
                    ></div>
                    @if (!editorHasText() || editorHasEmptyText()) {
                        <div
                            id="editor-placeholder"
                            [ngClass]="{
                                'editor-placeholder-dark-mode':
                                    darkModeService.isDarkMode
                            }"
                            data-test="editor-placeholder"
                        >
                            <span
                                class="editor-placeholder-text"
                                data-test="editor-placeholder-text"
                                >Shkruaj këtu ose </span
                            ><label
                                for="file-upload-input"
                                class="editor-placeholder-upload"
                                data-test="editor-placeholder-upload"
                                >ngarko një dokument</label
                            >
                        </div>
                    }
                    @if (editorHasText()) {
                        <div>
                            <button
                                type="button"
                                class="btn-close text-reset close-button-text-reset"
                                [ngClass]="{
                                    'clear-element-dark-mode':
                                        darkModeService.isDarkMode
                                }"
                                (click)="clearEditor()"
                                title="fshi shkrimin"
                                aria-label="fshi shkrimin"
                                data-test="clear-editor-icon"
                            ></button>
                        </div>
                    }
                </div>
                <hr class="editor-hr" />
                <div class="editor-toolbar">
                    <span
                        class="characters-words-markings"
                        [ngClass]="{
                            'characters-words-markings-dark-mode':
                                darkModeService.isDarkMode,
                            'max-editor-characters':
                                hasEditorOverMaxCharacters(),
                            'unconventional-editor-characters':
                                hasEditorUnconventionalCharacters()
                        }"
                        data-test="characters-words-markings"
                    >
                        @if (hasEditorOverMaxCharacters()) {
                            {{
                                MAX_EDITOR_CHARACTERS_MESSAGE
                            }}&nbsp;&nbsp;–&nbsp;
                        }
                        @if (hasEditorUnconventionalCharacters()) {
                            {{
                                UNCONVENTIONAL_CHARACTERS_MESSAGE
                            }}&nbsp;&nbsp;–&nbsp;
                        }
                        {{ characterCount }}&nbsp;{{
                            characterCount === 1 ? "karakter" : "karaktere"
                        }}&comma;&nbsp;{{ wordCount }}&nbsp;fjalë&comma;&nbsp;{{
                            processedText === undefined
                                ? 0
                                : processedText!.markings.length
                        }}&nbsp;{{
                            processedText !== undefined &&
                            processedText!.markings.length === 1
                                ? "shenjim"
                                : "shenjime"
                        }}</span
                    >
                    <span
                        ><button
                            id="copy-to-clipboard-button"
                            (click)="copyToClipboard()"
                            class="bi bi-clipboard editor-footer-button"
                            [ngClass]="{
                                'clipboard-button-dark-mode':
                                    darkModeService.isDarkMode
                            }"
                            title="kopjo shkrimin (c)"
                            data-test="copy-to-clipboard-button"
                        ></button
                        >&nbsp;&nbsp;&nbsp;&nbsp;<button
                            type="button"
                            data-bs-toggle="modal"
                            data-bs-target="#writings-history-modal"
                            title="trego historikun e shkrimeve (h)"
                            class="bi bi-clock-history editor-footer-button"
                            [ngClass]="{
                                'writings-history-button-dark-mode':
                                    darkModeService.isDarkMode
                            }"
                            data-test="writings-history-button"
                        ></button
                    ></span>
                </div>
            </div>

            <!-- TODO: is this a good place to put this? -->
            <input
                id="file-upload-input"
                class="d-none"
                onclick="this.value = null"
                type="file"
                (change)="uploadDocument($event)"
                placeholder="SHTYP KËTU"
                accept=".pdf,.doc,.docx,.odt"
            />
        </div>
    </div>
    <div class="output-container">
        @if (
            (processedText === undefined ||
                processedText!.markings.length === 0) &&
            !(loading$ | async)
        ) {
            <app-template-markings />
        }
        @if (processedText?.markings) {
            <div
                id="sticky-container"
                [ngClass]="{ sticky: highlightedMarkingIndex !== -1 }"
            >
                @if (highlightedMarkingIndex === -1) {
                    @for (
                        marking of processedText?.markings;
                        track marking;
                        let i = $index
                    ) {
                        @if (!shouldVeilMarkings[i]) {
                            <div
                                class="card border-secondary generated-marking-card"
                                [ngClass]="{ 'mt-2 mb-2': i > 0 }"
                                data-test="marking-card"
                            >
                                <div
                                    class="card-header generated-marking-card-header second-header"
                                    [ngClass]="{
                                        'second-header-dark-mode':
                                            darkModeService.isDarkMode
                                    }"
                                >
                                    <div class="generated-marking">
                                        <span
                                            class="marking {{
                                                marking.type
                                            }}-marking-header"
                                            data-test="marking-span"
                                            >{{ getTextOfMarking(i) }}
                                        </span>
                                    </div>
                                    <div>
                                        <button
                                            (click)="dismissMarking(i)"
                                            type="button"
                                            class="btn-close text-reset dismiss-marking-close-button"
                                            [ngClass]="{
                                                'dismiss-marking-element-dark-mode':
                                                    darkModeService.isDarkMode
                                            }"
                                            title="hiq shenjimin"
                                            aria-label="hiq shenjimin"
                                            data-test="dismiss-marking-button"
                                        ></button>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush">
                                    <li
                                        class="list-group-item generated-marking-list-group-item"
                                        [ngClass]="{
                                            'list-group-item-dark-mode':
                                                darkModeService.isDarkMode
                                        }"
                                    >
                                        <div class="information-circle-flex">
                                            <div>
                                                @if (
                                                    marking.type ===
                                                    "grammatical"
                                                ) {
                                                    <i
                                                        class="bi bi-stars generated-grammatical-marking-star"
                                                    ></i>
                                                }
                                                <b>{{ marking.subtype }}</b> -
                                                <span>{{
                                                    marking.description
                                                }}</span>
                                            </div>
                                            @if (marking.id) {
                                                <div>
                                                    <i
                                                        class="bi bi-info-circle information-circle"
                                                        routerLink="/{{
                                                            marking.id
                                                        }}"
                                                        data-test="marking-information-icon"
                                                    ></i>
                                                </div>
                                            }
                                        </div>
                                        @if (marking.suggestions.length > 0) {
                                            <span>
                                                <div class="suggestions">
                                                    @for (
                                                        suggestion of marking.suggestions.slice(
                                                            0,
                                                            shouldCollapseSuggestions[
                                                                i
                                                            ]
                                                                ? 4
                                                                : marking
                                                                      .suggestions
                                                                      .length
                                                        );
                                                        track suggestion;
                                                        let j = $index
                                                    ) {
                                                        <button
                                                            (click)="
                                                                chooseSuggestion(
                                                                    i,
                                                                    j
                                                                )
                                                            "
                                                            class="suggestion"
                                                            data-test="suggestion"
                                                            [ngClass]="{
                                                                'suggestion-dark-mode':
                                                                    darkModeService.isDarkMode
                                                            }"
                                                        >
                                                            <b>{{
                                                                suggestion.display
                                                            }}</b>
                                                        </button>
                                                    }
                                                    @if (
                                                        marking.suggestions
                                                            .length > 4
                                                    ) {
                                                        <div
                                                            class="pipe-separator"
                                                        >
                                                            |
                                                        </div>
                                                    }
                                                    @if (
                                                        marking.suggestions
                                                            .length > 4
                                                    ) {
                                                        <div>
                                                            <h3
                                                                (click)="
                                                                    oscillateSuggestion(
                                                                        i,
                                                                        $event
                                                                    )
                                                                "
                                                                class="bi suggestions-header {{
                                                                    shouldCollapseSuggestions[
                                                                        i
                                                                    ]
                                                                        ? 'bi-arrow-right-square'
                                                                        : 'bi-arrow-left-square'
                                                                }}"
                                                                data-test="oscillate-suggestions-button"
                                                            ></h3>
                                                        </div>
                                                    }
                                                </div>
                                            </span>
                                        }
                                    </li>
                                </ul>
                            </div>
                        } @else {
                            <app-veiled-marking
                                [veiledMarkingIndex]="i"
                            ></app-veiled-marking>
                        }
                    }
                } @else {
                    @if (!shouldVeilMarkings[highlightedMarkingIndex]) {
                        <div
                            class="card highlighted-marking-card border-secondary"
                            data-test="marking-card"
                        >
                            <div
                                class="card-header highlighted-marking-card-header second-header"
                                [ngClass]="{
                                    'second-header-dark-mode':
                                        darkModeService.isDarkMode
                                }"
                            >
                                <div class="generated-marking">
                                    <span
                                        class="marking {{
                                            processedText?.markings?.[
                                                highlightedMarkingIndex
                                            ]?.type
                                        }}-marking-header"
                                        data-test="highlighted-marking"
                                        >{{
                                            getTextOfMarking(
                                                highlightedMarkingIndex
                                            )
                                        }}</span
                                    >
                                </div>
                                <div>
                                    <button
                                        (click)="blurHighlightedBoardMarking()"
                                        class="btn btn-secondary blur-marking-button"
                                        data-test="blur-marking-button"
                                    >
                                        <i class="bi bi-arrow-left"></i>KTHEHU
                                    </button>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li
                                    class="list-group-item highlighted-marking-list-group-item"
                                    [ngClass]="{
                                        'list-group-item-dark-mode':
                                            darkModeService.isDarkMode
                                    }"
                                >
                                    <div class="information-circle-flex">
                                        <div>
                                            @if (
                                                processedText?.markings?.[
                                                    highlightedMarkingIndex
                                                ]?.subtype === "grammatical"
                                            ) {
                                                <i class="bi bi-stars"></i>
                                            }
                                            <b>{{
                                                processedText?.markings?.[
                                                    highlightedMarkingIndex
                                                ]?.subtype
                                            }}</b>
                                            -
                                            <span>{{
                                                processedText?.markings?.[
                                                    highlightedMarkingIndex
                                                ]?.description
                                            }}</span>
                                        </div>
                                        @if (
                                            processedText?.markings?.[
                                                highlightedMarkingIndex
                                            ]?.id
                                        ) {
                                            <div>
                                                <i
                                                    class="bi bi-info-circle information-circle"
                                                    routerLink="{{
                                                        processedText
                                                            ?.markings?.[
                                                            highlightedMarkingIndex
                                                        ]?.id
                                                    }}"
                                                    data-test="marking-information-icon"
                                                ></i>
                                            </div>
                                        }
                                    </div>
                                    @if (
                                        processedText?.markings?.[
                                            highlightedMarkingIndex
                                        ] !== undefined &&
                                        (processedText?.markings?.[
                                            highlightedMarkingIndex
                                        ]?.suggestions)!.length > 0
                                    ) {
                                        <span>
                                            <div class="suggestions">
                                                @for (
                                                    suggestion of processedText?.markings?.[
                                                        highlightedMarkingIndex
                                                    ]?.suggestions!.slice(
                                                        0,
                                                        shouldCollapseSuggestions[
                                                            highlightedMarkingIndex
                                                        ]
                                                            ? 4
                                                            : (processedText
                                                                  ?.markings?.[
                                                                  highlightedMarkingIndex
                                                              ]?.suggestions)!
                                                                  .length
                                                    );
                                                    track suggestion;
                                                    let j = $index
                                                ) {
                                                    <button
                                                        (click)="
                                                            chooseSuggestion(
                                                                highlightedMarkingIndex,
                                                                j
                                                            )
                                                        "
                                                        class="suggestion"
                                                        data-test="suggestion"
                                                    >
                                                        <b>{{
                                                            suggestion.display
                                                        }}</b>
                                                    </button>
                                                }
                                                @if (
                                                    (processedText?.markings?.[
                                                        highlightedMarkingIndex
                                                    ]?.suggestions)!.length > 4
                                                ) {
                                                    <div class="pipe-separator">
                                                        |
                                                    </div>
                                                }
                                                @if (
                                                    (processedText?.markings?.[
                                                        highlightedMarkingIndex
                                                    ]?.suggestions)!.length > 4
                                                ) {
                                                    <div>
                                                        <h3
                                                            (click)="
                                                                oscillateSuggestion(
                                                                    highlightedMarkingIndex,
                                                                    $event
                                                                )
                                                            "
                                                            class="bi suggestions-header"
                                                            [ngClass]="
                                                                shouldCollapseSuggestions[
                                                                    highlightedMarkingIndex
                                                                ]
                                                                    ? 'bi-arrow-right-square'
                                                                    : 'bi-arrow-left-square'
                                                            "
                                                            data-test="oscillate-suggestions-button"
                                                        ></h3>
                                                    </div>
                                                }
                                            </div>
                                        </span>
                                    }
                                </li>
                            </ul>
                        </div>
                    } @else {
                        <app-veiled-marking
                            [veiledMarkingIndex]="highlightedMarkingIndex"
                        ></app-veiled-marking>
                    }
                }
            </div>
        }
        @if (loading$ | async) {
            <app-loading-marking />
        }
    </div>
</div>

<div
    id="writings-history-modal"
    class="modal fade"
    tabindex="-1"
    aria-labelledby="writings-history-modal-label"
    aria-hidden="true"
>
    <div class="modal-dialog" data-test="modal-dialog">
        <div class="modal-content">
            <div
                class="modal-header"
                [ngClass]="{
                    'modal-header-dark-mode': darkModeService.isDarkMode
                }"
            >
                <h5 id="writings-history-modal-label" class="modal-title">
                    Historiku i Shkrimeve
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    [ngClass]="{
                        'btn-close-white': darkModeService.isDarkMode
                    }"
                    data-bs-dismiss="modal"
                    aria-label="Mbyll"
                ></button>
            </div>
            <div
                class="modal-body history-modal-body"
                [ngClass]="{
                    'modal-body-dark-mode': darkModeService.isDarkMode
                }"
                data-test="writings-history-modal-body"
            >
                <div class="form-check form-switch history-body">
                    <!-- TODO if user changes call a method that changes it in the service and invalidates-->
                    <label class="form-check-label" for="writings-input"
                        >Përdor Historikun e Shkrimeve</label
                    >
                    <label class="switch">
                        <input
                            (click)="toggleStoringOfWritings()"
                            id="writings-input"
                            type="checkbox"
                        />
                        <span
                            class="slider round"
                            data-test="writings-input"
                        ></span>
                    </label>
                    <div>
                        <span class="history-deactivation-message"
                            >çaktivizimi i historikut të shkrimeve do të fshijë
                            shkrimet ekzistuese</span
                        >
                    </div>
                </div>
                @for (
                    writing of writingsHistoryService.fetchWritingsHistory();
                    track writing
                ) {
                    <div class="list-group home-list-group">
                        <p
                            class="writing"
                            [ngClass]="{
                                'writings-history-dark-mode':
                                    darkModeService.isDarkMode
                            }"
                            (click)="placeWriting(writing)"
                            type="button"
                            data-test="writing"
                        >
                            {{ writing }}
                        </p>
                    </div>
                }
            </div>
            <div
                class="modal-footer"
                [ngClass]="{
                    'modal-footer-dark-mode': darkModeService.isDarkMode
                }"
            >
                <button
                    id="close-writings-history-modal-button"
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                    data-test="close-writings-history-modal-button"
                >
                    Mbyll
                </button>
            </div>
        </div>
    </div>
</div>

<button
    id="thank-you-modal-button"
    type="button"
    class="btn btn-primary thank-you-modal-button"
    data-bs-toggle="modal"
    data-bs-target="#thank-you-modal"
>
    Dialog per Falenderim
</button>
<div
    class="modal fade"
    id="thank-you-modal"
    tabindex="-1"
    aria-labelledby="thank-you-modal-label"
    aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered">
        <div
            class="modal-content"
            [ngClass]="{
                'modal-content-subscription-success-dark-mode':
                    darkModeService.isDarkMode
            }"
        >
            <div class="modal-header">
                <h5 class="modal-title" id="thank-you-modal-label">
                    Abonimi u Krye me Sukses
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    [ngClass]="{
                        'btn-close-white': darkModeService.isDarkMode
                    }"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <p>
                    Ju falenderojmë përzemërsisht për abonimin, shpresojmë që
                    Penda t'ju ndihmojë sa më shumë në shkrimet tuaja.
                </p>
                <p>
                    Për cdo paqartësi apo shqetësim mos ngurroni të na
                    kontaktoni te penda.information&#64;gmail.com
                </p>
            </div>
            <div class="modal-footer thank-you-modal-footer">
                <button
                    type="button"
                    class="btn btn-success continue-button-thank-you-modal"
                    data-bs-dismiss="modal"
                >
                    Vazhdo
                </button>
            </div>
        </div>
    </div>
</div>

<button
    id="welcome-modal-button"
    type="button"
    class="btn btn-primary welcome-modal-button"
    data-bs-toggle="modal"
    data-bs-target="#welcome-modal"
>
    Dialog per Mirësëardhje
</button>
<div
    class="modal fade"
    id="welcome-modal"
    tabindex="-1"
    aria-labelledby="welcome-modal-label"
    aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered">
        <div
            class="modal-content"
            [ngClass]="{
                'modal-content-welcome-dark-mode': darkModeService.isDarkMode
            }"
        >
            <div class="modal-header">
                <h5 class="modal-title" id="welcome-modal-label">
                    Mirë se Vini te Penda
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    [ngClass]="{
                        'btn-close-white': darkModeService.isDarkMode
                    }"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <p>
                    Për çdo paqartësi apo shqetësim mos ngurroni të na
                    kontaktoni te penda.information&#64;gmail.com
                </p>
            </div>
            <div class="modal-footer welcome-modal-footer-div">
                <button
                    type="button"
                    class="btn btn-success welcome-modal-continue-button"
                    data-bs-dismiss="modal"
                >
                    Vazhdo
                </button>
            </div>
        </div>
    </div>
</div>
